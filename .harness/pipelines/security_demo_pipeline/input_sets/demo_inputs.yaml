inputSet:
  name: Security Demo - Default Inputs
  identifier: demo_inputs
  orgIdentifier: stf
  projectIdentifier: harness_generic_template
  pipeline:
    identifier: security_demo_pipeline
    properties:
      ci:
        codebase:
          repoName: stfgit/nextly
          build:
            type: branch
            spec:
              branch: main
    stages:
      - stage:
          identifier: source_security_scan_hardened
          template:
            templateInputs:
              spec:
                infrastructure:
                  spec:
                    connectorRef: account.k8sdocacloud
                    namespace: harness-security-scan
                execution:
                  steps:
                    - step:
                        identifier: owasp
                        spec:
                          advanced:
                            fail_on_severity: medium
                          resources:
                            limits:
                              memory: 4Gi
                              cpu: 2000m
                    - step:
                        identifier: aquatrivy
                        spec:
                          advanced:
                            fail_on_severity: medium
                          resources:
                            limits:
                              memory: 3Gi
                              cpu: 1500m
                    - step:
                        identifier: gitleaks
                        spec:
                          advanced:
                            fail_on_severity: low
                          resources:
                            limits:
                              memory: 2Gi
                              cpu: 1000m
              delegateSelectors:
                - helm-delegate-k8s-fat
      - stage:
          identifier: secure_build_package
          template:
            templateInputs:
              spec:
                infrastructure:
                  spec:
                    connectorRef: account.k8sdocacloud
                    namespace: harness-ci-secure
                execution:
                  steps:
                    - step:
                        identifier: Install_Dependencies
                        spec:
                          connectorRef: org.Dockerhub
                          image: node:20-alpine
                    - step:
                        identifier: BuildAndPushDockerRegistry_1
                        spec:
                          connectorRef: org.Dockerhub
                          repo: stfgit/nextly-secure
      - stage:
          identifier: container_security_scan_hardened
          template:
            templateInputs:
              spec:
                infrastructure:
                  spec:
                    connectorRef: account.k8sdocacloud
                    namespace: harness-security-scan
                execution:
                  steps:
                    - step:
                        identifier: trivy_container_enterprise
                        spec:
                          image:
                            name: stfgit/nextly-secure
                            tag: secure-<+pipeline.sequenceId>
              delegateSelectors:
                - helm-delegate-k8s-fat
      - stage:
          identifier: security_policy_enforcement
          template:
            templateInputs:
              spec:
                infrastructure:
                  spec:
                    connectorRef: account.k8sdocacloud
                    namespace: harness-governance
              delegateSelectors:
                - helm-delegate-k8s-fat
      - stage:
          identifier: security_team_approval
          template:
            templateInputs:
              spec:
                execution:
                  steps:
                    - step:
                        identifier: approval
                        spec:
                          approvers:
                            minimumCount: 1
                            userGroups:
                              - org.DevOps_Team
              delegateSelectors:
                - ""
          when:
            condition: "true"
      - stage:
          identifier: secure_deploy_dev
          template:
            templateInputs:
              spec:
                environment:
                  environmentRef: dev
                  infrastructureDefinitions:
                    - identifier: infra_dev
                service:
                  serviceRef: mower_svc  # Service existant dans vos templates
                  serviceInputs:
                    serviceDefinition:
                      spec:
                        artifacts:
                          primary:
                            sources:
                              - identifier: secure_artifact
                                spec:
                                  tag: secure-<+pipeline.sequenceId>
              delegateSelectors:
                - helm-delegate
    delegateSelectors:
      - helm-delegate-k8s-fat