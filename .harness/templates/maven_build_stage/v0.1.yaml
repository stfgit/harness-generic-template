template:
  name: maven build stage
  identifier: maven_build_stage
  versionLabel: v0.1
  type: Stage
  projectIdentifier: harness_generic_template
  orgIdentifier: stf
  tags: {}
  icon: data:image/png;base64,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
  spec:
    type: CI
    spec:
      cloneCodebase: true
      infrastructure:
        type: KubernetesDirect
        spec:
          connectorRef: <+input>
          namespace: <+input>.default(harness-ci)
          automountServiceAccountToken: true
          nodeSelector: {}
          os: Linux
      execution:
        steps:
          - step:
              type: Run
              name: mvn build
              identifier: mvn_build
              spec:
                connectorRef: <+input>
                image: <+input>.default(maven:3.9.6-eclipse-temurin-21)
                shell: Bash
                command: |-
                  echo "Configuring Maven cache directory..."
                  mkdir -p /harness/.m2/repository

                  echo "🔨 Starting Maven build..."
                  mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -Dmaven.repo.local=/harness/.m2/repository -s settings.xml -B -V
                  echo "✅ Maven build completed successfully"

                  # Afficher les artefacts créés
                  echo "📦 Generated artifacts:"
                  ls -la target/*.jar 2>/dev/null || echo "No JAR files found"
          - step:
              type: Run
              name: mvn test with coverage
              identifier: mvn_test_with_coverage
              spec:
                connectorRef: <+input>
                image: <+input>.default(maven:3.9.6-eclipse-temurin-21)
                shell: Bash
                command: |-
                  echo "🧪 Running tests with JaCoCo coverage..."

                  mvn test jacoco:report -B -Dmaven.repo.local=/harness/.m2/repository -s settings.xml

                  if [ -d "target/site/jacoco" ]; then
                    echo "📈 Coverage Summary:"
                    if [ -f target/site/jacoco/jacoco.csv ]; then
                      echo "🔍 Analyzing JaCoCo CSV..."
                      
                      # Sommer toutes les lignes (sauf l'en-tête)
                      # Colonnes: 8=LINE_MISSED, 9=LINE_COVERED
                      TOTALS=$(awk -F',' '
                        BEGIN { missed=0; covered=0 }
                        NR>1 { 
                          # Nettoyer les retours chariot et sommer
                          gsub(/\r/, "", $8); gsub(/\r/, "", $9)
                          if ($8 ~ /^[0-9]+$/) missed += $8
                          if ($9 ~ /^[0-9]+$/) covered += $9
                        }
                        END { print missed "," covered }
                      ' target/site/jacoco/jacoco.csv)
                      
                      LINE_MISSED=$(echo "$TOTALS" | cut -d',' -f1)
                      LINE_COVERED=$(echo "$TOTALS" | cut -d',' -f2)
                      LINE_TOTAL=$((LINE_MISSED + LINE_COVERED))

                      echo "📊 Coverage calculation:"
                      echo "   Lines missed: $LINE_MISSED"
                      echo "   Lines covered: $LINE_COVERED"  
                      echo "   Total lines: $LINE_TOTAL"

                      if [ "$LINE_TOTAL" -gt 0 ]; then
                        LINE_PERCENT=$(awk -v covered="$LINE_COVERED" -v total="$LINE_TOTAL" \
                          'BEGIN { printf("%.1f", total>0 ? covered*100/total : 0) }')
                        echo "📊 Line Coverage: ${LINE_PERCENT}% ($LINE_COVERED/$LINE_TOTAL lines)"
                        
                        # Affichage par classe pour debug
                        echo ""
                        echo "📋 Coverage by class:"
                        awk -F',' 'NR>1 { 
                          gsub(/\r/, "", $8); gsub(/\r/, "", $9)
                          if ($8 ~ /^[0-9]+$/ && $9 ~ /^[0-9]+$/) {
                            total = $8 + $9
                            if (total > 0) {
                              percent = $9 * 100 / total
                              printf("   %-30s: %5.1f%% (%d/%d)\n", $3, percent, $9, total)
                            }
                          }
                        }' target/site/jacoco/jacoco.csv
                        
                      else
                        echo "❌ No lines found for coverage calculation"
                        LINE_PERCENT="0.0"
                      fi
                      
                      echo ""
                      echo "🔍 Manual verification:"
                      echo "Calculated result: ${LINE_PERCENT}% (${LINE_COVERED}/${LINE_TOTAL} lines)"
                      
                    fi
                  else
                    echo "⚠️ JaCoCo report directory not found"
                    mvn jacoco:help -Ddetail=true
                  fi
                outputVariables:
                  - name: COVERAGE_PERCENT
                    type: String
                    value: LINE_PERCENT
              description: Uses Jacoco
          - step:
              type: Run
              name: coverage quality gate
              identifier: coverage_quality_gate
              spec:
                connectorRef: <+input>
                image: <+runtime>.default(alpine:latest)
                shell: Bash
                command: |-
                  # Installer bc pour les calculs (si pas disponible)
                  apk add --no-cache bc >/dev/null 2>&1 || true

                  echo "🎯 COVERAGE QUALITY GATE"
                  echo "======================="

                  # Récupérer la variable de l'étape précédente
                  COVERAGE="<+pipeline.stages.Build_and_test.spec.execution.steps.Maven_Test_Coverage.output.outputVariables.COVERAGE_PERCENT>"

                  echo "📊 Current Coverage: ${COVERAGE}%"

                  # Définir les seuils
                  MIN_COVERAGE=70
                  TARGET_COVERAGE=80

                  # Vérification des seuils
                  if [ "$(echo "${COVERAGE} >= ${TARGET_COVERAGE}" | bc -l)" -eq 1 ]; then
                    echo "🎉 EXCELLENT! Coverage ${COVERAGE}% exceeds target ${TARGET_COVERAGE}%"
                    exit 0
                  elif [ "$(echo "${COVERAGE} >= ${MIN_COVERAGE}" | bc -l)" -eq 1 ]; then
                    echo "✅ PASS! Coverage ${COVERAGE}% meets minimum ${MIN_COVERAGE}%"
                    echo "💡 Try to reach target ${TARGET_COVERAGE}% for excellent quality"
                    exit 0
                  else
                    echo "❌ FAIL! Coverage ${COVERAGE}% below minimum ${MIN_COVERAGE}%"
                    echo "🚨 Deployment blocked - please improve test coverage"
                    exit 1
                  fi
          - step:
              type: BuildAndPushDockerRegistry
              name: build and push docker image
              identifier: build_and_push_docker_image
              spec:
                connectorRef: <+input>
                repo: <+input>
                tags:
                  - <+pipeline.executionId>
                  - latest
