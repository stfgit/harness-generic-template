template:
  name: jira approval
  identifier: jira_approval
  versionLabel: v0.1
  type: Stage
  tags: {}
  spec:
    type: Approval
    spec:
      execution:
        steps:
          - step:
              name: create ticket
              identifier: create_ticket
              type: JiraCreate
              timeout: 5m
              spec:
                connectorRef: <+input>
                projectKey: <+input>
                issueType: <+input>
                fields:
                  - name: Résumé
                    value: "Demande d'approbation pour déploiement PRODUCTION (version: <+pipeline.sequenceId>)"
                  - name: Type de ticket
                    value: Déploiement
          - step:
              name: jira approval
              identifier: jira_approval
              type: JiraApproval
              timeout: 1d
              spec:
                connectorRef: <+stage.spec.execution.steps.create_ticket.spec.connectorRef>
                issueKey: <+steps.create_ticket.issueKey>
                approvalCriteria:
                  type: Jexl
                  spec:
                    expression: <+issue.Status == "Validé">
                rejectionCriteria:
                  type: KeyValues
                  spec:
                    matchAnyCondition: false
                    conditions:
                      - key: Status
                        operator: equals
                        value: Roll back
                retryInterval: 1m
